<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- MENGAMBIL DATA DARI BACKEND API ---
    // !!! GANTI URL DI BAWAH INI DENGAN URL PUBLIK REPLIT ANDA !!!
    const BASE_API_URL = 'https://<URL-REPLIT-ANDA>/api/v1/trends';

    let trendsData = {
        keywords: [],
        categories: ["Technology", "Lifestyle", "Business", "Nature", "Holiday/Seasonal", "Abstract", "People", "Food", "Travel", "Education"],
        events: [
            { date: "2025-09-01", name: "Back to School", keywords: ["school supplies", "education", "classroom"] },
            { date: "2025-10-31", name: "Halloween", keywords: ["spooky", "pumpkin", "costume party"] },
            { date: "2025-11-28", name: "Black Friday", keywords: ["sale", "shopping", "discount"] },
            { date: "2025-12-25", name: "Christmas", keywords: ["christmas tree", "winter", "holiday season"] }
        ],
        notifications: [
            { id: 1, text: "New seasonal event 'Halloween' is approaching. Prepare your content.", read: false, time: "1 day ago" },
            { id: 2, text: "Welcome to TrendLens! Check out the dashboard for today's top trends.", read: true, time: "3 days ago" }
        ]
    };

    const fetchData = async () => {
        const goldenKeywordsContainer = document.getElementById('golden-keywords-container');
        goldenKeywordsContainer.innerHTML = `<div class="loader"></div>`;

        try {
            // LANGKAH 1: Meminta backend untuk memulai analisis
            const startResponse = await fetch(`${BASE_API_URL}/start_analysis`);
            await startResponse.json();

            // LANGKAH 2: Melakukan polling setiap 5 detik untuk mendapatkan hasil
            const pollInterval = setInterval(async () => {
                const resultsResponse = await fetch(`${BASE_API_URL}/results`);
                const result = await resultsResponse.json();
                
                if (result.status === "completed") {
                    clearInterval(pollInterval);
                    trendsData.keywords = result.data.map(item => ({
                        id: item.id,
                        keyword: item.keyword,
                        demand: item.demand_score,
                        competition: item.competition_count,
                        category: "N/A",
                        type: "N/A",
                        trend: [0, 0, 0, 0, item.demand_score],
                        rising: true, 
                        related: [] 
                    }));
                    console.log("Data berhasil dimuat dari API:", trendsData.keywords);
                    renderDashboard();
                    renderExplore();
                } else {
                    console.log("Analisis masih berjalan...");
                }
            }, 5000); // Poll setiap 5 detik

        } catch (error) {
            console.error("Gagal mengambil data dari API:", error);
            goldenKeywordsContainer.innerHTML = `<p class="text-center text-red-400 mt-6">
                Could not load trend data. Make sure the API URL is correct and the backend server is running.
            </p>`;
        }
    };
    
    // --- UTILITY FUNCTIONS ---
    const getScoreColor = (score, type = 'demand') => {
        if (type === 'competition') {
            if (score < 1000000) return 'text-green-400';
            if (score < 5000000) return 'text-yellow-400';
            return 'text-red-400';
        }
        if (score >= 75) return 'text-green-400';
        if (score >= 50) return 'text-yellow-400';
        return 'text-red-400';
    };

    const getTrendIcon = (trend) => {
        return `<span class="text-green-400">â–²</span>`;
    };
    
    const formatCompetition = (num) => {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num;
    };

    const createKeywordElement = (item) => {
        const element = document.createElement('div');
        element.className = 'keyword-item bg-gray-700/50 p-4 rounded-lg flex items-center justify-between hover:bg-gray-700 transition-colors cursor-pointer';
        element.dataset.keywordId = item.id;
        element.innerHTML = `
            <div>
                <p class="font-semibold text-white">${item.keyword} ${getTrendIcon(item.trend)}</p>
                <p class="text-sm text-gray-400">${item.category} / ${item.type}</p>
            </div>
            <div class="flex items-center space-x-4 text-right">
                <div>
                    <p class="text-xs text-gray-400">Demand</p>
                    <p class="font-bold ${getScoreColor(item.demand, 'demand')}">${item.demand}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-400">Competition</p>
                    <p class="font-bold ${getScoreColor(item.competition, 'competition')}">${formatCompetition(item.competition)}</p>
                </div>
            </div>
        `;
        element.addEventListener('click', () => openKeywordModal(item.id));
        return element;
    };

    // --- VIEW RENDERING ---
    const renderDashboard = () => {
        const goldenKeywordsContainer = document.getElementById('golden-keywords-container');
        const risingTrendsContainer = document.getElementById('rising-trends-container');
        const upcomingEventsContainer = document.getElementById('upcoming-events-container');

        goldenKeywordsContainer.innerHTML = '';
        risingTrendsContainer.innerHTML = '';
        
        const goldenKeywords = trendsData.keywords
            .filter(k => k.demand > 60 && k.competition < 5000000)
            .slice(0, 5);
        goldenKeywords.forEach(item => goldenKeywordsContainer.appendChild(createKeywordElement(item)));

        const risingTrends = trendsData.keywords.slice(0, 5);
        risingTrends.forEach(item => risingTrendsContainer.appendChild(createKeywordElement(item)));
        
        const upcomingEvents = trendsData.events
            .filter(e => dayjs(e.date).isAfter(dayjs()))
            .slice(0, 3);
        upcomingEvents.forEach(event => {
            const eventEl = document.createElement('div');
            eventEl.className = 'bg-gray-700/50 p-3 rounded-lg flex items-center';
            eventEl.innerHTML = `
                <div class="text-center mr-4 bg-blue-500/20 p-2 rounded-md">
                    <p class="text-xs text-blue-300">${dayjs(event.date).format('MMM')}</p>
                    <p class="font-bold text-lg text-white">${dayjs(event.date).format('DD')}</p>
                </div>
                <div>
                    <p class="font-semibold text-white">${event.name}</p>
                    <p class="text-xs text-gray-400">${event.keywords.slice(0,2).join(', ')}...</p>
                </div>`;
            upcomingEventsContainer.appendChild(eventEl);
        });
    };

    const renderExplore = () => {
        const container = document.getElementById('explore-results-container');
        const categoryFilter = document.getElementById('filter-category');
        const freemiumMsg = document.getElementById('freemium-limit-msg');
        
        categoryFilter.innerHTML = '<option value="all">All Categories</option>';
        trendsData.categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.toLowerCase();
            option.textContent = cat;
            categoryFilter.appendChild(option);
        });

        const applyFilters = () => {
            const searchTerm = document.getElementById('search-keyword').value.toLowerCase();
            const filteredData = trendsData.keywords.filter(k => 
                k.keyword.toLowerCase().includes(searchTerm)
            );

            container.innerHTML = '';
            const dataToShow = filteredData.slice(0, FREEMIUM_LIMIT);
            dataToShow.forEach(item => container.appendChild(createKeywordElement(item)));

            freemiumMsg.style.display = filteredData.length > FREEMIUM_LIMIT ? 'block' : 'none';
        };

        document.getElementById('search-keyword').addEventListener('input', applyFilters);
        document.getElementById('filter-category').style.display = 'none';
        document.getElementById('filter-type').style.display = 'none';
        document.getElementById('filter-region').addEventListener('change', (e) => {
            if (e.target.value !== 'global') {
                openUpgradeModal();
                e.target.value = 'global';
            }
        });
        
        applyFilters();
    };
    
    // --- CALENDAR LOGIC ---
    let currentDate = dayjs();
    const renderCalendar = () => {
        dayjs.extend(window.dayjs_plugin_weekday);
        dayjs.extend(window.dayjs_plugin_weekOfYear);

        const calendarGrid = document.getElementById('calendar-grid');
        const calendarTitle = document.getElementById('calendar-title');
        const eventDetailsContainer = document.getElementById('calendar-event-details');

        calendarGrid.innerHTML = '';
        eventDetailsContainer.innerHTML = '';
        calendarTitle.textContent = currentDate.format('MMMM YYYY');

        const startOfMonth = currentDate.startOf('month');
        const endOfMonth = currentDate.endOf('month');
        const startDay = startOfMonth.weekday();

        const daysInMonth = [];
        for (let i = 0; i < startDay; i++) {
            daysInMonth.push(null);
        }
        for (let i = 1; i <= endOfMonth.date(); i++) {
            daysInMonth.push(startOfMonth.date(i));
        }

        const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        weekDays.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = 'text-center font-bold text-gray-400 text-sm';
            dayEl.textContent = day;
            calendarGrid.appendChild(dayEl);
        });

        daysInMonth.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day p-2 text-center rounded-lg cursor-pointer';
            if (day) {
                dayEl.textContent = day.date();
                const event = trendsData.events.find(e => dayjs(e.date).isSame(day, 'day'));
                if (event) {
                    dayEl.classList.add('bg-blue-600', 'text-white', 'font-bold', 'relative');
                    dayEl.innerHTML += `<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 bg-yellow-300 rounded-full"></span>`;
                    dayEl.addEventListener('click', () => showEventDetails(event));
                }
                if (day.isSame(dayjs(), 'day')) {
                    dayEl.classList.add('border-2', 'border-blue-400');
                }
            } else {
                dayEl.classList.add('opacity-0');
            }
            calendarGrid.appendChild(dayEl);
        });
    };

    const showEventDetails = (event) => {
        const container = document.getElementById('calendar-event-details');
        container.innerHTML = `
            <div class="bg-gray-700/50 p-4 rounded-lg">
                <h4 class="text-lg font-semibold text-white">${event.name} - ${dayjs(event.date).format('MMMM D')}</h4>
                <p class="text-gray-300 mt-2">Recommended Keywords:</p>
                <div class="flex flex-wrap gap-2 mt-2">
                    ${event.keywords.map(kw => `<span class="bg-blue-500/50 text-blue-200 text-sm font-medium px-2.5 py-0.5 rounded-full">${kw}</span>`).join('')}
                </div>
            </div>`;
    };

    document.getElementById('prev-month').addEventListener('click', () => {
        currentDate = currentDate.subtract(1, 'month');
        renderCalendar();
    });
    document.getElementById('next-month').addEventListener('click', () => {
        currentDate = currentDate.add(1, 'month');
        renderCalendar();
    });

    const renderNotifications = () => {
        const container = document.getElementById('notifications-container');
        container.innerHTML = '';
        trendsData.notifications.forEach(notif => {
            const el = document.createElement('div');
            el.className = `p-4 rounded-lg flex justify-between items-center ${notif.read ? 'bg-gray-800/50' : 'bg-blue-900/50 border border-blue-700'}`;
            el.innerHTML = `
                <div>
                    <p class="text-white">${notif.text}</p>
                    <p class="text-sm text-gray-400">${notif.time}</p>
                </div>
                ${!notif.read ? '<button class="text-sm text-blue-300 hover:underline">Mark as read</button>' : ''}
            `;
            container.appendChild(el);
        });
    };

    // --- MODAL LOGIC ---
    const openKeywordModal = (id) => {
        const item = trendsData.keywords.find(k => k.id === id);
        if (!item) return;

        document.getElementById('modal-title').textContent = item.keyword;
        document.getElementById('modal-demand').textContent = item.demand;
        document.getElementById('modal-demand').className = `font-bold text-lg ${getScoreColor(item.demand, 'demand')}`;
        document.getElementById('modal-competition').textContent = formatCompetition(item.competition);
        document.getElementById('modal-competition').className = `font-bold text-lg ${getScoreColor(item.competition, 'competition')}`;
        
        const relatedContainer = document.getElementById('modal-related');
        relatedContainer.innerHTML = item.related.map(kw => `<span class="bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full">${kw}</span>`).join('');

        keywordModal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);

        // Chart.js rendering
        const chartCanvas = document.getElementById('trend-chart');
        if (chartInstance) {
            chartInstance.destroy();
        }
        chartInstance = new Chart(chartCanvas, {
            type: 'line',
            data: {
                labels: ['-4w', '-3w', '-2w', 'Last Week', 'This Week'],
                datasets: [{
                    label: 'Popularity Trend',
                    data: item.trend,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' } },
                    x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' } }
                }
            }
        });
    };

    const closeKeywordModal = () => {
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => keywordModal.classList.add('hidden'), 300);
    };
    
    const openUpgradeModal = () => {
        upgradeModal.classList.remove('hidden');
        setTimeout(() => {
            upgradeModalContent.classList.remove('scale-95', 'opacity-0');
            upgradeModalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    const closeUpgradeModal = () => {
        upgradeModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => upgradeModal.classList.add('hidden'), 300);
    };

    closeModalBtn.addEventListener('click', closeKeywordModal);
    keywordModal.addEventListener('click', (e) => {
        if (e.target === keywordModal) closeKeywordModal();
    });
    
    document.getElementById('upgrade-btn').addEventListener('click', openUpgradeModal);
    document.getElementById('upgrade-link-explore').addEventListener('click', (e) => {
        e.preventDefault();
        openUpgradeModal();
    });
    closeUpgradeModalBtn.addEventListener('click', closeUpgradeModal);
    upgradeModal.addEventListener('click', (e) => {
        if (e.target === upgradeModal) closeUpgradeModal();
    });


    // --- NAVIGATION ---
    const switchView = (viewId) => {
        views.forEach(view => view.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');

        navLinks.forEach(link => link.classList.remove('active-nav'));
        document.getElementById(`nav-${viewId.split('-')[1]}`).classList.add('active-nav');
    };

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const viewId = `view-${link.id.split('-')[1]}`;
            switchView(viewId);
        });
    });

    // --- INITIALIZATION ---
    // Panggil fungsi fetchData, kemudian setelah selesai, render semua bagian
    fetchData().then(() => {
        renderCalendar();
        renderNotifications();
        switchView('view-dashboard');
    });
});
</script>
</body>
</html>
